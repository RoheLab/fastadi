<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="fastadi">
<title>Using memory-efficient sparse computations • fastadi</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using memory-efficient sparse computations">
<meta property="og:description" content="fastadi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">fastadi</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9019</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/adaptive-impute.html">An introduction to AdaptiveInitialize and AdaptiveImpute</a>
    <a class="dropdown-item" href="../articles/efficient-sparse-computation.html">Using memory-efficient sparse computations</a>
    <a class="dropdown-item" href="../articles/sparse-matrix-intro.html">Introduction to sparse computations</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/RoheLab/fastadi/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="efficient-sparse-computation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using memory-efficient sparse computations</h1>
                        <h4 data-toc-skip class="author">Alex Hayes</h4>
            
            <h4 data-toc-skip class="date">2022-02-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/RoheLab/fastadi/blob/HEAD/vignettes/efficient-sparse-computation.Rmd" class="external-link"><code>vignettes/efficient-sparse-computation.Rmd</code></a></small>
      <div class="d-none name"><code>efficient-sparse-computation.Rmd</code></div>
    </div>

    
    

<div class="section level3">
<h3 id="low-rank-implementation">Low-rank implementation<a class="anchor" aria-label="anchor" href="#low-rank-implementation"></a>
</h3>
<p>The reference implementation has some problems. As our data matrix <span class="math inline">\(M\)</span> gets larger, we can no longer fit the dense representation of <span class="math inline">\(\hat M\)</span> and <span class="math inline">\(Z^{(t)}\)</span> into memory. Instead, we need to work with just the low rank components <span class="math inline">\(\hat \lambda, \hat U\)</span> and <span class="math inline">\(\hat V\)</span>.</p>
<p>This leads us to following implementation:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">low_rank_adaptive_initialize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span>
  
  <span class="va">p_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/nnzero.html" class="external-link">nnzero</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>  <span class="co"># line 1</span>
  
  <span class="co"># NOTE: skip explicit computation of line 2</span>
  <span class="co"># NOTE: skip explicit computation of line 3</span>
  
  <span class="va">eig_p</span> <span class="op">&lt;-</span> <span class="fu">eigen_helper</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
  <span class="va">eig_t</span> <span class="op">&lt;-</span> <span class="fu">eigen_helper</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>, <span class="va">r</span><span class="op">)</span>
  
  <span class="va">lr_v_hat</span> <span class="op">&lt;-</span> <span class="va">eig_p</span><span class="op">$</span><span class="va">vectors</span>  <span class="co"># line 4</span>
  <span class="va">lr_u_hat</span> <span class="op">&lt;-</span> <span class="va">eig_t</span><span class="op">$</span><span class="va">vectors</span>  <span class="co"># line 5</span>
  
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  
  <span class="co"># NOTE: alpha is again incorrect since we work with eigenvalues</span>
  <span class="co"># rather than singular values here</span>
  <span class="va">sum_eigen_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M</span><span class="op">@</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">p</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">M</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  <span class="va">lr_alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sum_eigen_values</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">eig_p</span><span class="op">$</span><span class="va">values</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span>  <span class="co"># line 6</span>
  
  <span class="va">lr_lambda_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">eig_p</span><span class="op">$</span><span class="va">values</span> <span class="op">-</span> <span class="va">lr_alpha</span><span class="op">)</span> <span class="op">/</span> <span class="va">p_hat</span>  <span class="co"># line 7</span>
  
  <span class="co"># TODO: Karl had another sign computation here that he said was faster</span>
  <span class="co"># but it wasn't documented anywhere, so I'm going with what was in the </span>
  <span class="co"># paper</span>
  
  <span class="va">lr_svd_M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
  
  <span class="co"># v_hat is d by r</span>
  <span class="va">lr_v_sign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">d</span><span class="op">)</span>, <span class="va">lr_svd_M</span><span class="op">$</span><span class="va">v</span> <span class="op">*</span> <span class="va">lr_v_hat</span><span class="op">)</span>
  <span class="va">lr_u_sign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>, <span class="va">lr_svd_M</span><span class="op">$</span><span class="va">u</span> <span class="op">*</span> <span class="va">lr_u_hat</span><span class="op">)</span>
  <span class="va">lr_s_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign</a></span><span class="op">(</span><span class="va">lr_v_sign</span> <span class="op">*</span> <span class="va">lr_u_sign</span><span class="op">)</span><span class="op">)</span>  <span class="co"># line 8</span>
  
  <span class="va">lr_lambda_hat</span> <span class="op">&lt;-</span> <span class="va">lr_lambda_hat</span> <span class="op">*</span> <span class="va">lr_s_hat</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">lr_u_hat</span>, d <span class="op">=</span> <span class="va">lr_lambda_hat</span>, v <span class="op">=</span> <span class="va">lr_v_hat</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>What does <code>eigen_helper()</code> do? Describe the return object (also do this for svds)</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Take the eigendecomposition of t(M) %*% M - (1 - p) * diag(t(M) %*% M)</span>
<span class="co"># using sparse computations only</span>
<span class="va">eigen_helper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/eigs.html" class="external-link">eigs_sym</a></span><span class="op">(</span>
    <span class="va">Mx</span>, <span class="va">r</span>,
    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>,
    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      M <span class="op">=</span> <span class="va">M</span>,
      p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/nnzero.html" class="external-link">nnzero</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># compute (t(M) %*% M / p^2 - (1 - p) * diag(diag(t(M) %*% M))) %*% x</span>
<span class="co"># using sparse operations</span>

<span class="co"># TODO: divide the second term by p^2 like in the reference implementatio</span>
<span class="va">Mx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">args</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">M</span>, <span class="va">args</span><span class="op">$</span><span class="va">M</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="va">args</span><span class="op">$</span><span class="va">p</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">args</span><span class="op">$</span><span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">M</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">M</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now we check that <code>Mx</code> works</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.3</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">M</span> <span class="op">/</span> <span class="va">p</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">M</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span>
<span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu">Mx</span><span class="op">(</span><span class="va">x</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>M <span class="op">=</span> <span class="va">M</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="check-the-computation-of-alpha-for-p-s-d--matrices">check the computation of alpha for p.s.d. matrices<a class="anchor" aria-label="anchor" href="#check-the-computation-of-alpha-for-p-s-d--matrices"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/toeplitz.html" class="external-link">toeplitz</a></span><span class="op">(</span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/rWishart.html" class="external-link">rWishart</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="va">S</span><span class="op">)</span><span class="op">[</span>, ,<span class="fl">1</span><span class="op">]</span>
<span class="va">R</span>

<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>

<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">M</span> <span class="op">&lt;-</span> <span class="va">ml100k</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># nuclear norm</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">M</span>, type <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span>

<span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>

<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">r</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span>
<span class="va">alpha</span>

<span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">r</span><span class="op">]</span></code></pre></div>
<p>TODO: update alg description to divide by <span class="math inline">\(p^2\)</span> to get the right singular values</p>
<p>Quickly check that the components works before we try the code that integrates them all together</p>
<p>Finally, sanity check this by comparing to the reference implementation. These don’t agree, which isn’t great:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lr_init</span> <span class="op">&lt;-</span> <span class="fu">sparse_adaptive_initialize</span><span class="op">(</span><span class="va">dat</span>, <span class="va">r</span><span class="op">)</span>

<span class="co"># some weird stuff is happening with the singular values but I'm</span>
<span class="co"># going to not worry about it for the time being</span>

<span class="fu">equal_svds</span><span class="op">(</span><span class="va">init</span>, <span class="va">lr_init</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="space-efficient-adaptive-impute">Space-efficient adaptive impute<a class="anchor" aria-label="anchor" href="#space-efficient-adaptive-impute"></a>
</h3>
<p>TODO: figure out the actual space complexity</p>
<p>Recall the algorithm looks like</p>
<p><span class="math display">\[\begin{align}
\hat M = \sum_{i=1}^r \hat s_i  \hat \lambda_i \hat U_i \hat V_i^T
\end{align}\]</span></p>

<p>Now we need two things:</p>
<ol style="list-style-type: decimal">
<li>The SVD of <span class="math inline">\(\tilde M^{(t)}\)</span>
</li>
<li>(Certain sums of) the squared singular values.</li>
</ol>
<div class="section level4">
<h4 id="sums-of-squared-singular-values">Sums of squared singular values<a class="anchor" aria-label="anchor" href="#sums-of-squared-singular-values"></a>
</h4>
<p>For a matrix <span class="math inline">\(A\)</span>, the sum of squared singular values (denoted by <span class="math inline">\(\lambda_i\)</span>) equals the squared frobenius norm:</p>
<p><span class="math display">\[\begin{align}
\sum_{i=1}^{\min(n, d)} \lambda_i^2 = ||A||_F^2 = \mathop{\mathrm{trace}}(A^T A)
\end{align}\]</span></p>
<p>Also note that</p>
<p><span class="math display">\[\begin{align}
||A + B||_F^2 = ||A||_F^2 + ||B||_F^2 + 2 \cdot \langle A, B \rangle_F
\end{align}\]</span></p>
<p>Now we consider <span class="math inline">\(\tilde M^{(t)}\)</span>. Suppose that unobserved values of <span class="math inline">\(M\)</span> are set to zero, as is the case for <span class="math inline">\(M\)</span> stored in a sparse matrix representation</p>
<p><span class="math display">\[\begin{align}
\tilde M^{(t)} &amp;= P_\Omega(M) + P_\Omega^\perp (Z_t) \\
&amp;= P_\Omega(M) + P_\Omega^\perp \left(
  \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
  \right)
\end{align}\]</span></p>
<p>Now we need</p>
<p><span class="math display">\[\begin{align}
||\tilde M^{(t)}||_F^2 
&amp;= \left \Vert
  P_\Omega(M) + P_\Omega^\perp \left(
    \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
    \right)
  \right \Vert_F^2 \\
&amp;= \left \Vert P_\Omega(M) \right \Vert_F^2 
  + \left \Vert P_\Omega^\perp \left(
      \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
    \right)
  \right \Vert_F^2
  + 2 \cdot \left \langle P_\Omega(M), P_\Omega^\perp \left(
      \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
    \right) \right \rangle_F \\
&amp;= \left \Vert P_\Omega(M) \right \Vert_F^2 
  + \left \Vert P_\Omega^\perp \left(
      \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
    \right)
  \right \Vert_F^2
\end{align}\]</span></p>
<p>Where the cancellation in the final line follows because</p>
<p><span class="math display">\[\begin{align}
\left \langle P_\Omega(M), P_\Omega^\perp
  \left(
    \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
  \right)
\right \rangle_F
= \sum_{i, j} P_\Omega(M)_{ij} \cdot P_\Omega^\perp (Z_t)_{ij}
= \sum_{i, j} 0
= 0
\end{align}\]</span></p>
<p>Now we need one more trick, which is that</p>
<p><span class="math display">\[\begin{align}
\left \Vert Z_t \right \Vert_F^2
= \left \Vert P_\Omega (Z_t) + P_\Omega^\perp (Z_t) \right \Vert_F^2
= \left \Vert P_\Omega (Z_t) \right \Vert_F^2 + 
  \left \Vert P_\Omega^\perp (Z_t) \right \Vert_F^2
\end{align}\]</span></p>
<p>and then</p>
<p><span class="math display">\[\begin{align}
\left \Vert P_\Omega^\perp (Z_t) \right \Vert_F^2
= \left \Vert Z_t \right \Vert_F^2
  - \left \Vert P_\Omega (Z_t) \right \Vert_F^2 \\
= \sum_{i = 1}^r \lambda_i^2 - \left \Vert Z_t \odot Y \right \Vert_F^2
\end{align}\]</span></p>
<p>Putting it all together we see</p>
<p><span class="math display">\[\begin{align}
||\tilde M^{(t)}||_F^2 
&amp;= \left \Vert P_\Omega(M) \right \Vert_F^2 
  + \left \Vert P_\Omega^\perp \left(
      \sum_{i=1}^r \hat \lambda_i^{(t)} \hat U_i^{(t)} \hat V_i^{(t)^T}
    \right)
  \right \Vert_F^2 \\
&amp;= \left \Vert M \right \Vert_F^2 + 
  \sum_{i = 1}^r \lambda_i^2 - 
  \left \Vert Z_t \odot Y \right \Vert_F^2
\end{align}\]</span></p>
<p>In code we will have a sparse matrix <code>M</code> and a list <code>s</code> with elements of the SVD. The first Frobenious norm is quick to calculate, but I am not sure how to calculate the other two frobenius norms.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># s is a matrix defined in terms of it's svd</span>
<span class="co"># G is a sparse matrix</span>
<span class="co"># compute only elements of U %*% diag(d) %*% t(V) only on non-zero elements of G</span>
<span class="co"># G and U %*% t(V) must have same dimensions</span>

<span class="co"># maybe call this svd_perp?</span>
<span class="va">svd_perp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">mask</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># note: must be dgTMatrix to get column indexes j larger</span>
  <span class="co"># what if we used dlTMatrix here?</span>
  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">mask</span>, <span class="st">"dgTMatrix"</span><span class="op">)</span>
  
  <span class="co"># the indices for which we want to compute the matrix multiplication</span>
  <span class="co"># turn zero based indices into one based indices</span>
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">@</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="va">j</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">@</span><span class="va">j</span> <span class="op">+</span> <span class="fl">1</span>

  <span class="co"># gets rows and columns of U and V to multiply, then multiply</span>
  <span class="va">ud</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>
  <span class="va">left</span> <span class="op">&lt;-</span> <span class="va">ud</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>
  <span class="va">right</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">[</span><span class="va">j</span>, <span class="op">]</span>

  <span class="co"># compute inner products to get elements of U %*% t(V)</span>
  <span class="va">uv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">left</span> <span class="op">*</span> <span class="va">right</span><span class="op">)</span>

  <span class="co"># NOTE: specify dimensions just in case</span>
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/sparseMatrix.html" class="external-link">sparseMatrix</a></span><span class="op">(</span>i <span class="op">=</span> <span class="va">i</span>, j <span class="op">=</span> <span class="va">j</span>, x <span class="op">=</span> <span class="va">uv</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Test it</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>

<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/rsparsematrix.html" class="external-link">rsparsematrix</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">12</span>, nnz <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">5</span><span class="op">)</span>

<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"lgCMatrix"</span><span class="op">)</span>

<span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span>
  <span class="fu">svd_perp</span><span class="op">(</span><span class="va">s</span>, <span class="va">M</span><span class="op">)</span>,
  <span class="va">Z</span> <span class="op">*</span> <span class="va">y</span>
<span class="op">)</span></code></pre></div>
<p>So, to take an eigendecomp you just need to be able to do <span class="math inline">\(Mx\)</span>. To take an SVD, what do you need? matrix vector and matrix transpose vector multiplication</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>
<span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/rsparsematrix.html" class="external-link">rsparsematrix</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">12</span>, nnz <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"lgCMatrix"</span><span class="op">)</span>

<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>

<span class="va">M_tilde</span> <span class="op">&lt;-</span> <span class="va">M</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span>  <span class="co"># dense!</span>

<span class="va">Z_perp</span> <span class="op">&lt;-</span> <span class="fu">svd_perp</span><span class="op">(</span><span class="va">s</span>, <span class="va">M</span><span class="op">)</span>
<span class="va">sum_singular_squared</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M</span><span class="op">@</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Z_perp</span><span class="op">@</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">M_tilde</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,
  <span class="va">sum_singular_squared</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="svd-of-m-tilde">SVD of M tilde<a class="anchor" aria-label="anchor" href="#svd-of-m-tilde"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>
<span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/rsparsematrix.html" class="external-link">rsparsematrix</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">12</span>, nnz <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"lgCMatrix"</span><span class="op">)</span>

<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>

<span class="va">M_tilde</span> <span class="op">&lt;-</span> <span class="va">M</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span>  <span class="co"># dense!</span>

<span class="va">svd_M_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">M_tilde</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">svd_M_tilde</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Ax</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">args</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">M_tilde</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">Atx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">args</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">M_tilde</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># is eigs_sym() with a two-sided multiply faster?</span>
<span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span>, d <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">d</span>, v <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">v</span>, m <span class="op">=</span> <span class="va">M</span><span class="op">)</span>
<span class="va">test1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">Ax</span>, k <span class="op">=</span> <span class="va">r</span>, Atrans <span class="op">=</span> <span class="va">Atx</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>, args <span class="op">=</span> <span class="va">args</span><span class="op">)</span>

<span class="va">test1</span>
<span class="va">svd_M_tilde</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span>
  <span class="va">svd_M_tilde</span>,
  <span class="va">test1</span>
<span class="op">)</span></code></pre></div>
<p>So we’re done our first sanity check of the function interface. Let <span class="math inline">\(x\)</span> be a vector. Now we want to calculate</p>
<p><span class="math display">\[\begin{align}
\tilde M^{(t)} x 
  &amp;= \left[ P_\Omega(M) + P_\Omega^\perp (Z_t) \right] x \\
  &amp;= \left[ P_\Omega(M) -
    P_\Omega (Z_t) +
    P_\Omega (Z_t) +
    P_\Omega^\perp (Z_t) \right] x \\
  &amp;= P_\Omega(M - Z_t) x + Z_t x
\end{align}\]</span></p>
<p>where we can think of <span class="math inline">\(R_t \equiv P_\Omega(M - Z_t)\)</span> as “residuals” of sorts. Crucially, <span class="math inline">\(R_t\)</span> is sparse, and</p>
<p><span class="math display">\[\begin{align}
Z_t x &amp;= (\hat U 
  \mathop{\mathrm{diag}}(\hat \lambda_1, ..., \hat \lambda_r)
  \hat V^t) x \\
  &amp;= (\hat U 
  (\mathop{\mathrm{diag}}(\hat \lambda_1, ..., \hat \lambda_r)
  (\hat V^t x)))
\end{align}\]</span></p>
<p>So now the memory requirement of the computation has been reduced to that of two sparse matrix vector multiplications, rather than that of fitting the dense matrix <span class="math inline">\(P_\Omega^\perp (Z_t)\)</span> into memory.</p>
<p>Similarly, for the transpose, we have</p>
<p><span class="math display">\[\begin{align}
\tilde M^{{(t)}^T} x 
  &amp;= \left[ P_\Omega(M) + P_\Omega^\perp (Z_t) \right]^T x \\
  &amp;= \left[ P_\Omega(M) -
    P_\Omega (Z_t) +
    P_\Omega (Z_t) +
    P_\Omega^\perp (Z_t) \right]^T x \\
  &amp;= P_\Omega(M - Z_t)^T x + Z_t^T x
\end{align}\]</span></p>
<p>This leads us to a second, less memory intensive implementation of <code>Ax()</code> and <code>Atx()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># input: M, Z_t as a low-rank SVD list s</span>

<span class="va">R</span> <span class="op">&lt;-</span> <span class="va">M</span> <span class="op">-</span> <span class="fu">svd_perp</span><span class="op">(</span><span class="va">s</span>, <span class="va">M</span><span class="op">)</span>  <span class="co"># residual matrix</span>
<span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span>, d <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">d</span>, v <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">v</span>, R <span class="op">=</span> <span class="va">R</span><span class="op">)</span>

<span class="va">Ax</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">args</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">R</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span> <span class="op">+</span> <span class="va">args</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">v</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">Atx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">args</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># TODO: can we use a crossprod() for the first multiplication here?</span>
  <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">R</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span> <span class="op">+</span> <span class="va">args</span><span class="op">$</span><span class="va">v</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">u</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># is eigs_sym() with a two-sided multiply faster?</span>
<span class="va">test2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">Ax</span>, k <span class="op">=</span> <span class="va">r</span>, Atrans <span class="op">=</span> <span class="va">Atx</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>, args <span class="op">=</span> <span class="va">args</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span>
  <span class="va">svd_M_tilde</span>,
  <span class="va">test2</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">relative_f_norm_change</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s_new</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># TODO: don't do the dense calculation here</span>
  
  <span class="va">Z_new</span> <span class="op">&lt;-</span> <span class="va">s_new</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s_new</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s_new</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>
  <span class="va">Z_new</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">Z_new</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Z</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sparse_adaptive_impute</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span>, <span class="va">epsilon</span> <span class="op">=</span> <span class="fl">1e-03</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># coerce M to sparse matrix such that we use sparse operations</span>
  <span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span>
  
  <span class="co"># low rank svd-like object, s ~ Z_1</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">sparse_adaptive_initialize</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>  <span class="co"># line 1</span>
  <span class="va">delta</span> <span class="op">&lt;-</span> <span class="cn">Inf</span>
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="va">norm_M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M</span><span class="op">@</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>

  <span class="kw">while</span> <span class="op">(</span><span class="va">delta</span> <span class="op">&gt;</span> <span class="va">epsilon</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co"># update s: lines 4 and 5</span>
    <span class="co"># take the SVD of M-tilde</span>
    
    <span class="va">R</span> <span class="op">&lt;-</span> <span class="va">M</span> <span class="op">-</span> <span class="fu">svd_perp</span><span class="op">(</span><span class="va">s</span>, <span class="va">M</span><span class="op">)</span>  <span class="co"># residual matrix</span>
    <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span>, d <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">d</span>, v <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">v</span>, R <span class="op">=</span> <span class="va">R</span><span class="op">)</span>
    
    <span class="va">s_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">Ax</span>, k <span class="op">=</span> <span class="va">r</span>, Atrans <span class="op">=</span> <span class="va">Atx</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>, args <span class="op">=</span> <span class="va">args</span><span class="op">)</span>
    
    <span class="va">MtM</span> <span class="op">&lt;-</span> <span class="va">norm_M</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_new</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">svd_perp</span><span class="op">(</span><span class="va">s_new</span>, <span class="va">M</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
    <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">MtM</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_new</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span>  <span class="co"># line 6</span>
    
    <span class="va">s_new</span><span class="op">$</span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">s_new</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span>  <span class="co"># line 7</span>
    
    <span class="co"># NOTE: skip explicit computation of line 8</span>
    <span class="va">delta</span> <span class="op">&lt;-</span> <span class="fu">relative_f_norm_change</span><span class="op">(</span><span class="va">s_new</span>, <span class="va">s</span><span class="op">)</span>
    
    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s_new</span>
    
    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"delta: {round(delta, 8)}, alpha: {round(alpha, 3)}"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">s</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">sparse_adaptive_impute</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">out</span></code></pre></div>
<p><span class="math display">\[\begin{align}
\texttt{MtM} = \tilde M^{{(t)}^T} \tilde M^{(t)}
\end{align}\]</span></p>
</div>
</div>
<div class="section level3">
<h3 id="extension-to-a-mixture-of-observed-and-unobserved-missingness">Extension to a mixture of observed and unobserved missingness<a class="anchor" aria-label="anchor" href="#extension-to-a-mixture-of-observed-and-unobserved-missingness"></a>
</h3>
<p>originally solving an optimization vaguely of the form</p>
<p><span class="math display">\[\begin{align}
\left \Vert M - \hat M \right \Vert_F^2
\end{align}\]</span></p>
<p>where <span class="math inline">\(M\)</span> is a partially observed matrix. now, we let <span class="math inline">\(M' = Y M\)</span> where <span class="math inline">\(Y\)</span> is an indicator of whether or not <span class="math inline">\(M\)</span> was observed. Typically we have some setup like</p>
<p><span class="math display">\[\begin{align}
M = 
 \begin{bmatrix}
    \cdot &amp; \cdot &amp; 3     &amp; 1     &amp; \cdot \\
    3     &amp; \cdot &amp; \cdot &amp; 8     &amp; \cdot \\
    \cdot &amp; -1    &amp; \cdot &amp; \cdot &amp; \cdot \\
    \cdot &amp; \cdot &amp; \cdot &amp; \cdot &amp; \cdot \\
    \cdot &amp; 2     &amp; \cdot &amp; \cdot &amp; \cdot \\
    5     &amp; \cdot &amp; 7     &amp; \cdot &amp; 4
  \end{bmatrix}
, \qquad
Y = 
  \begin{bmatrix}
    \cdot &amp; \cdot &amp; 1     &amp; 1     &amp; \cdot \\
    1     &amp; \cdot &amp; \cdot &amp; 1     &amp; \cdot \\
    \cdot &amp; 1     &amp; \cdot &amp; \cdot &amp; \cdot \\
    \cdot &amp; \cdot &amp; \cdot &amp; \cdot &amp; \cdot \\
    \cdot &amp; 1     &amp; \cdot &amp; \cdot &amp; \cdot \\
    1     &amp; \cdot &amp; 1     &amp; \cdot &amp; 1
  \end{bmatrix}
\end{align}\]</span></p>
<p>Here the symbol <span class="math inline">\(\cdot\)</span> means that an entry of the matrix was unobserved.</p>
<p>but what we do now is, continuing to represent <span class="math inline">\(M\)</span> as a sparse matrix with no zero entries, is <em>observe</em> a bunch of zeros. So we might know that the upper triangule of <span class="math inline">\(M\)</span> has structurally missing zeros that we have observed are missing. These zeros are primarily important because they affect the residuals in our calculations. In this particular case, the take multiplication by <span class="math inline">\(M\)</span>, a sparse operation, and make it into a dense operation.</p>
<p>At this point it becomes useful to introduce some additional notation. Let <span class="math inline">\(\tilde \Omega\)</span> be the set of indicies <span class="math inline">\((i, j)\)</span> such that <span class="math inline">\(M_{i, j}\)</span> is non-zero. Observe that <span class="math inline">\(\tilde \Omega \subset \Omega\)</span>. Then we have <span class="math inline">\(P_{\tilde \Omega} (A) = P_\Omega (A)\)</span>.</p>
<p><span class="math display">\[\begin{align}
M = 
 \begin{bmatrix}
    0     &amp; 0     &amp; 3     &amp; 1     &amp; 0 \\
    3     &amp; 0     &amp; 0     &amp; 8     &amp; 0 \\
    \cdot &amp; -1    &amp; 0     &amp; 0     &amp; 0 \\
    \cdot &amp; \cdot &amp; \cdot &amp; 0     &amp; 0 \\
    \cdot &amp; 2     &amp; \cdot &amp; \cdot &amp; 0 \\
    5     &amp; \cdot &amp; 7     &amp; \cdot &amp; 4
  \end{bmatrix}
, \qquad
Y = 
  \begin{bmatrix}
    1     &amp; 1     &amp; 1     &amp; 1     &amp; 1 \\
    1     &amp; 1     &amp; 1     &amp; 1     &amp; 1 \\
    \cdot &amp; 1     &amp; 1     &amp; 1     &amp; 1 \\
    \cdot &amp; \cdot &amp; \cdot &amp; 1     &amp; 1 \\
    \cdot &amp; 1     &amp; \cdot &amp; \cdot &amp; 1 \\
    1     &amp; \cdot &amp; 1     &amp; \cdot &amp; 1
  \end{bmatrix}
, \qquad
M' = 
 \begin{bmatrix}
    \cdot &amp; \cdot &amp; 3     &amp; 1     &amp; \cdot \\
    3     &amp; \cdot &amp; \cdot &amp; 8     &amp; \cdot \\
    \cdot &amp; -1    &amp; \cdot &amp; \cdot &amp; \cdot \\
    \cdot &amp; \cdot &amp; \cdot &amp; \cdot &amp; \cdot \\
    \cdot &amp; 2     &amp; \cdot &amp; \cdot &amp; \cdot \\
    5     &amp; \cdot &amp; 7     &amp; \cdot &amp; 4
  \end{bmatrix}
\end{align}\]</span></p>
<p>Temporary scratch for presentation</p>
<p><span class="math display">\[\begin{align}
A = 
 \begin{bmatrix}
    0 &amp; 0 &amp; 1 &amp; 1 &amp; 0 \\
    ? &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
    ? &amp; ? &amp; 0 &amp; 0 &amp; 0 \\
    ? &amp; ? &amp; ? &amp; 0 &amp; 1 \\
    ? &amp; ? &amp; ? &amp; ? &amp; 0 \\
    ? &amp; ? &amp; ? &amp; ? &amp; 0
  \end{bmatrix}
\end{align}\]</span></p>
<p>And now we need to figure out how to calculate</p>
<p><span class="math display">\[\begin{align}
\tilde M^{(t)} x 
  &amp;= \left[ P_\Omega(M) + P_\Omega^\perp (Z_t) \right] x \\
  &amp;= \left[ P_\Omega(M) -
    P_\Omega (Z_t) +
    P_\Omega (Z_t) +
    P_\Omega^\perp (Z_t) \right] x \\
  &amp;= P_\Omega(M)  - P_\Omega(Z_t) x + Z_t x \\
  &amp;= P_{\tilde \Omega}(M)  - P_\Omega(Z_t) x + Z_t x
\end{align}\]</span></p>
<p>We already know how to calculate <span class="math inline">\(P_{\tilde \Omega}(M)\)</span> and <span class="math inline">\(Z_t x\)</span> using sparse operations, so we’re left with <span class="math inline">\(P_\Omega(Z_t) x\)</span>. Note that <span class="math inline">\(P_\Omega(Z_t) x \neq P_{\tilde \Omega} (Z_t) x\)</span> since <span class="math inline">\(Z_t\)</span> is not necessarily zero on <span class="math inline">\(\tilde \Omega^\perp\)</span>. In other words <span class="math inline">\(P_\Omega^\perp (Z_t) \neq Z_t\)</span>.</p>
<p>When <span class="math inline">\(Y\)</span> is dense, there is no way to avoid paying the computational cost of the dense or near dense computation. Our primary concern is fitting <span class="math inline">\(Y\)</span> into memory for large datasets. This is an issue when <span class="math inline">\(Y\)</span> is dense but with no discernible structure that permits a more compact representation.</p>
<p>If we can fit <span class="math inline">\(Y\)</span> into memory, we can do a low-rank computation, only calculating elements <span class="math inline">\(Z^{(t)}_{ij}\)</span> when <span class="math inline">\(Y_{ij} = 1\)</span>. When <span class="math inline">\(Y\)</span> is stored as a vector of row indices together with a vector of column indices (plus some information about the dimension), we can write the computation out:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">8</span>, <span class="fl">0</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">2</span><span class="op">)</span>

<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">Y</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span>

<span class="co"># triplet form</span>
<span class="co"># compressed column matrix form even better but don't</span>
<span class="co"># understand the format</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">Y</span>, <span class="st">"lgCMatrix"</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">Y</span>, <span class="st">"lgTMatrix"</span><span class="op">)</span>

<span class="co"># ugh: RcppArmadillo only supports dgTMatrix rather than</span>
<span class="co"># lgTMatrix which is somewhat unfortunate</span>

<span class="co"># link: https://cran.r-project.org/web/packages/RcppArmadillo/vignettes/RcppArmadillo-sparseMatrix.pdf</span>

<span class="va">Y</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>

<span class="co"># want to calculate</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">Y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span><span class="op">)</span>
<span class="va">out</span></code></pre></div>
<p>At this point it’s worth writing out explicitly how calculate <span class="math inline">\(Z^{(t)}_{ij}\)</span>.</p>
<p><span class="math display">\[\begin{align}
Z^{(t)}_{ij} 
&amp;= \left( \sum_{\ell=1}^r \hat U_\ell \hat d_\ell \hat V_\ell^T \right)_{ij}
\end{align}\]</span></p>
<p>For a visual reminder, this looks like (using <span class="math inline">\(\mathop{\mathrm{diag}}(\hat d)\)</span> and <span class="math inline">\(\hat \Sigma\)</span> somewhat interchangeably here)</p>
<p><span class="math display">\[\begin{align}
Z^{(t)}
= \hat U \mathop{\mathrm{diag}}(\hat d) \, \hat V^T
= 
\begin{bmatrix}
  U_1 &amp; U_2 &amp; \hdots &amp; U_r \\
\end{bmatrix}
\begin{bmatrix}
  d_{1} &amp; 0 &amp; \hdots &amp; 0 \\
  0 &amp; d_{2} &amp; \hdots &amp; 0 \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  0 &amp; 0 &amp; \hdots &amp; d_{r}
\end{bmatrix}
\begin{bmatrix}
  V_1^T \\
  V_2^T \\
  \vdots \\
  V_r^T
\end{bmatrix}
\end{align}\]</span></p>
<p><span class="math display">\[\begin{align}
\begin{bmatrix}
  U_{11} &amp; U_{12} &amp; \hdots &amp; U_{1r} \\
  U_{21} &amp; U_{22} &amp; \hdots &amp; U_{2r} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  U_{n1} &amp; U_{n2} &amp; \hdots &amp; U_{nr}
\end{bmatrix}
\begin{bmatrix}
  d_{1} &amp; 0 &amp; \hdots &amp; 0 \\
  0 &amp; d_{2} &amp; \hdots &amp; 0 \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  0 &amp; 0 &amp; \hdots &amp; d_{r}
\end{bmatrix}
\begin{bmatrix}
  V_{11} &amp; V_{21} &amp; \hdots &amp; V_{d1} \\
  V_{12} &amp; V_{22} &amp; \hdots &amp; V_{d2} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  V_{1r} &amp; V_{2r} &amp; \hdots &amp; V_{dr}
\end{bmatrix}
\end{align}\]</span></p>
<p>n x d = (n x r) x (r x r) x (r x d)</p>
<p>(r x d) is after the transpose</p>
<p><span class="math display">\[\begin{align}
\begin{bmatrix}
  U_{11} &amp; U_{12} &amp; \hdots &amp; U_{1r} \\
  U_{21} &amp; U_{22} &amp; \hdots &amp; U_{2r} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  U_{n1} &amp; U_{n2} &amp; \hdots &amp; U_{nr}
\end{bmatrix}
\begin{bmatrix}
  d_{1} &amp; 0 &amp; \hdots &amp; 0 \\
  0 &amp; d_{2} &amp; \hdots &amp; 0 \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  0 &amp; 0 &amp; \hdots &amp; d_{r}
\end{bmatrix}
\begin{bmatrix}
  V_{11} &amp; V_{21} &amp; \hdots &amp; V_{d1} \\
  V_{12} &amp; V_{22} &amp; \hdots &amp; V_{d2} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  V_{1r} &amp; V_{2r} &amp; \hdots &amp; V_{dr}
\end{bmatrix}
\end{align}\]</span></p>
<p>Also because I never remember anything, recall that <span class="math inline">\(Z\)</span> is <span class="math inline">\(n \times d\)</span>, <span class="math inline">\(x\)</span> is <span class="math inline">\(d \times 1\)</span> and <span class="math inline">\(Zx\)</span> is <span class="math inline">\(n \times 1\)</span>:</p>
<p><span class="math display">\[\begin{align}
(Zx)_i = \sum_{j=1}^d Z_{ij} \cdot x_j
\end{align}\]</span></p>
<p>(recall that <span class="math inline">\(X_i\)</span> always refers to the <span class="math inline">\(i^{th}\)</span> column of <span class="math inline">\(X\)</span> in this document)</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mask as a pair list</span>
<span class="co"># L and Z / svd are both n x d matrices</span>
<span class="co"># x is a d x 1 matrix / vector</span>
<span class="va">masked_svd_times_x</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">mask</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">mask</span>, <span class="st">"lgTMatrix"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">u</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span>
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">d</span>
  <span class="va">v</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">v</span>
  
  <span class="va">zx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># lgTMatrix uses zero based indexing, add one</span>
  <span class="va">row</span> <span class="op">&lt;-</span> <span class="va">mask</span><span class="op">@</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="va">col</span> <span class="op">&lt;-</span> <span class="va">mask</span><span class="op">@</span><span class="va">j</span> <span class="op">+</span> <span class="fl">1</span>
  
  <span class="co"># need to loop over index of indexes</span>
  <span class="co"># double looping over i and j here feels intuitive</span>
  <span class="co"># but is incorrect</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">row</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">row</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>
    <span class="va">j</span> <span class="op">&lt;-</span> <span class="va">col</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>
    
    <span class="va">z_ij</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">*</span> <span class="va">d</span> <span class="op">*</span> <span class="va">v</span><span class="op">[</span><span class="va">j</span>, <span class="op">]</span><span class="op">)</span>
    <span class="va">zx</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">zx</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">z_ij</span>
  <span class="op">}</span>
  
  <span class="va">zx</span>
<span class="op">}</span>

<span class="co"># how to calculate just one element of the reconstructed</span>
<span class="co"># data using the SVD</span>

<span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">6</span>
<span class="va">j</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">u</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">*</span> <span class="va">s</span><span class="op">$</span><span class="va">d</span> <span class="op">*</span> <span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">[</span><span class="va">j</span>, <span class="op">]</span><span class="op">)</span>
<span class="va">Z</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span>

<span class="co"># the whole masked matrix multiply</span>

<span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">Y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">x</span><span class="op">)</span>

<span class="co"># check that we did this right</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span>
  <span class="fu">masked_svd_times_x</span><span class="op">(</span><span class="va">s</span>, <span class="va">Y</span>, <span class="va">x</span><span class="op">)</span>,
  <span class="va">out</span>
<span class="op">)</span></code></pre></div>
<p>This is gonna be painfully slow in R so we rewrite in C++</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw">using</span> <span class="kw">namespace</span> arma;</span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb19-7"><a href="#cb19-7"></a></span>
<span id="cb19-8"><a href="#cb19-8"></a>vec masked_svd_times_x_impl(</span>
<span id="cb19-9"><a href="#cb19-9"></a>  <span class="at">const</span> mat&amp; U,</span>
<span id="cb19-10"><a href="#cb19-10"></a>  <span class="at">const</span> rowvec&amp; d,</span>
<span id="cb19-11"><a href="#cb19-11"></a>  <span class="at">const</span> mat&amp; V,</span>
<span id="cb19-12"><a href="#cb19-12"></a>  <span class="at">const</span> vec&amp; row,</span>
<span id="cb19-13"><a href="#cb19-13"></a>  <span class="at">const</span> vec&amp; col,</span>
<span id="cb19-14"><a href="#cb19-14"></a>  <span class="at">const</span> vec&amp; x) {</span>
<span id="cb19-15"><a href="#cb19-15"></a>  </span>
<span id="cb19-16"><a href="#cb19-16"></a>  <span class="dt">int</span> i, j;</span>
<span id="cb19-17"><a href="#cb19-17"></a>  <span class="dt">double</span> z_ij;</span>
<span id="cb19-18"><a href="#cb19-18"></a>  </span>
<span id="cb19-19"><a href="#cb19-19"></a>  vec zx = zeros&lt;vec&gt;(U.n_rows);</span>
<span id="cb19-20"><a href="#cb19-20"></a>  </span>
<span id="cb19-21"><a href="#cb19-21"></a>  <span class="cf">for</span> (<span class="dt">int</span> idx = <span class="dv">0</span>; idx &lt; row.n_elem; idx++) {</span>
<span id="cb19-22"><a href="#cb19-22"></a>    </span>
<span id="cb19-23"><a href="#cb19-23"></a>    i = row(idx);</span>
<span id="cb19-24"><a href="#cb19-24"></a>    j = col(idx);</span>
<span id="cb19-25"><a href="#cb19-25"></a>    </span>
<span id="cb19-26"><a href="#cb19-26"></a>    <span class="co">// % does elementwise multiplication in Armadillo</span></span>
<span id="cb19-27"><a href="#cb19-27"></a>    <span class="co">// accu() gives the sum of elements of resulting vector</span></span>
<span id="cb19-28"><a href="#cb19-28"></a>    z_ij = accu(U.row(i) % d % V.row(j));</span>
<span id="cb19-29"><a href="#cb19-29"></a>    </span>
<span id="cb19-30"><a href="#cb19-30"></a>    zx(i) += x(j) * z_ij;</span>
<span id="cb19-31"><a href="#cb19-31"></a>  }</span>
<span id="cb19-32"><a href="#cb19-32"></a>  </span>
<span id="cb19-33"><a href="#cb19-33"></a>  <span class="cf">return</span> zx;</span>
<span id="cb19-34"><a href="#cb19-34"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># wrap with slightly nicer interface</span>
<span class="va">masked_svd_times_x_cpp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">mask</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu">masked_svd_times_x_impl</span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">u</span>, <span class="va">s</span><span class="op">$</span><span class="va">d</span>, <span class="va">s</span><span class="op">$</span><span class="va">v</span>, <span class="va">mask</span><span class="op">@</span><span class="va">i</span>, <span class="va">mask</span><span class="op">@</span><span class="va">j</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
  <span class="fu">masked_svd_times_x_cpp</span><span class="op">(</span><span class="va">s</span>, <span class="va">Y</span>, <span class="va">x</span><span class="op">)</span>,
  <span class="fu">masked_svd_times_x</span><span class="op">(</span><span class="va">s</span>, <span class="va">Y</span>, <span class="va">x</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>TODO:</p>
<ul>
<li>the tranpose multiplication</li>
<li>the average singular value calculation</li>
</ul>
<p>Recall that to calculate the average singular value we want</p>
<p><span class="math display">\[\begin{align}
||\tilde M^{(t)}||_F^2
&amp;= \left \Vert M \right \Vert_F^2 + 
  \sum_{i = 1}^r \lambda_i^2 - 
  \left \Vert Z_t \odot Y \right \Vert_F^2
\end{align}\]</span></p>
<p>This is the other computationally intensive part so let’s write it up in Armadillo as well</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="kw">using</span> <span class="kw">namespace</span> arma;</span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb22-7"><a href="#cb22-7"></a></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="dt">double</span> p_omega_f_norm_impl(</span>
<span id="cb22-9"><a href="#cb22-9"></a>      <span class="at">const</span> mat&amp; U,</span>
<span id="cb22-10"><a href="#cb22-10"></a>      <span class="at">const</span> rowvec&amp; d,</span>
<span id="cb22-11"><a href="#cb22-11"></a>      <span class="at">const</span> mat&amp; V,</span>
<span id="cb22-12"><a href="#cb22-12"></a>      <span class="at">const</span> vec&amp; row,</span>
<span id="cb22-13"><a href="#cb22-13"></a>      <span class="at">const</span> vec&amp; col) {</span>
<span id="cb22-14"><a href="#cb22-14"></a>  </span>
<span id="cb22-15"><a href="#cb22-15"></a>    <span class="dt">int</span> i, j;</span>
<span id="cb22-16"><a href="#cb22-16"></a>    <span class="dt">double</span> total = <span class="dv">0</span>;</span>
<span id="cb22-17"><a href="#cb22-17"></a>  </span>
<span id="cb22-18"><a href="#cb22-18"></a>    <span class="cf">for</span> (<span class="dt">int</span> idx = <span class="dv">0</span>; idx &lt; row.n_elem; idx++) {</span>
<span id="cb22-19"><a href="#cb22-19"></a>  </span>
<span id="cb22-20"><a href="#cb22-20"></a>      i = row(idx);</span>
<span id="cb22-21"><a href="#cb22-21"></a>      j = col(idx);</span>
<span id="cb22-22"><a href="#cb22-22"></a>  </span>
<span id="cb22-23"><a href="#cb22-23"></a>      total += accu(U.row(i) % d % V.row(j));</span>
<span id="cb22-24"><a href="#cb22-24"></a>    }</span>
<span id="cb22-25"><a href="#cb22-25"></a>  </span>
<span id="cb22-26"><a href="#cb22-26"></a>    <span class="cf">return</span> total;</span>
<span id="cb22-27"><a href="#cb22-27"></a>  }</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># wrap with slightly nicer interface</span>
<span class="va">p_omega_f_norm_cpp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">mask</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">p_omega_f_norm_impl</span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">u</span>, <span class="va">s</span><span class="op">$</span><span class="va">d</span>, <span class="va">s</span><span class="op">$</span><span class="va">v</span>, <span class="va">mask</span><span class="op">@</span><span class="va">i</span>, <span class="va">mask</span><span class="op">@</span><span class="va">j</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">Y</span><span class="op">)</span>,
  <span class="fu">p_omega_f_norm_cpp</span><span class="op">(</span><span class="va">s</span>, <span class="va">Y</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="section level4">
<h4 id="a-naive-solution-the-epsilon-trick">A naive solution: the epsilon trick<a class="anchor" aria-label="anchor" href="#a-naive-solution-the-epsilon-trick"></a>
</h4>
<p>issue: we’ve moved back into dense computation land</p>
</div>
<div class="section level4">
<h4 id="the-memory-efficient-version">The memory efficient version<a class="anchor" aria-label="anchor" href="#the-memory-efficient-version"></a>
</h4>
<p>asdf</p>
<p>TODO: don’t coerce to explicit Matrix class as that is not recommended apparently. alternatives?</p>
</div>
</div>
<div class="section level3">
<h3 id="fully-c-implementation-dense">Fully C++ implementation: Dense<a class="anchor" aria-label="anchor" href="#fully-c-implementation-dense"></a>
</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="kw">using</span> <span class="kw">namespace</span> arma;</span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>Rcpp::List AdaptiveInitialize(<span class="at">const</span> sp_mat&amp; M, <span class="at">const</span> <span class="dt">int</span> r) {</span>
<span id="cb25-8"><a href="#cb25-8"></a></span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="co">// coerce to double to avoid integer division</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>  <span class="dt">double</span> p_hat = <span class="kw">static_cast</span>&lt;<span class="dt">double</span>&gt;(M.n_nonzero) / (M.n_cols * M.n_rows);</span>
<span id="cb25-11"><a href="#cb25-11"></a>  </span>
<span id="cb25-12"><a href="#cb25-12"></a>  sp_mat MtM = M.t() * M;</span>
<span id="cb25-13"><a href="#cb25-13"></a>  sp_mat MMt = M * M.t();</span>
<span id="cb25-14"><a href="#cb25-14"></a>  </span>
<span id="cb25-15"><a href="#cb25-15"></a>  sp_mat sigma_p = MtM / pow(p_hat, <span class="dv">2</span>) - (<span class="dv">1</span> - p_hat) * diagmat(MtM);</span>
<span id="cb25-16"><a href="#cb25-16"></a>  sp_mat <span class="dt">sigma_t</span> = MMt / pow(p_hat, <span class="dv">2</span>) - (<span class="dv">1</span> - p_hat) * diagmat(MMt);</span>
<span id="cb25-17"><a href="#cb25-17"></a></span>
<span id="cb25-18"><a href="#cb25-18"></a>  mat U_p, V_p, <span class="dt">U_t</span>, <span class="dt">V_t</span>;</span>
<span id="cb25-19"><a href="#cb25-19"></a>  vec <span class="va">s_p</span>, <span class="va">s_t</span>;</span>
<span id="cb25-20"><a href="#cb25-20"></a></span>
<span id="cb25-21"><a href="#cb25-21"></a>  svds(U_p, <span class="va">s_p</span>, V_p, sigma_p, r);</span>
<span id="cb25-22"><a href="#cb25-22"></a>  svds(<span class="dt">U_t</span>, <span class="va">s_t</span>, <span class="dt">V_t</span>, <span class="dt">sigma_t</span>, r);</span>
<span id="cb25-23"><a href="#cb25-23"></a></span>
<span id="cb25-24"><a href="#cb25-24"></a>  <span class="co">// </span><span class="al">TODO</span><span class="co">: this is still the eigenvalue calculation</span></span>
<span id="cb25-25"><a href="#cb25-25"></a>  <span class="dt">double</span> alpha = (sum(sigma_p.diag()) - sum(<span class="va">s_p</span>)) / (M.n_cols - r);</span>
<span id="cb25-26"><a href="#cb25-26"></a></span>
<span id="cb25-27"><a href="#cb25-27"></a>  vec lambda_hat = sqrt(<span class="va">s_p</span> - alpha) / p_hat;</span>
<span id="cb25-28"><a href="#cb25-28"></a></span>
<span id="cb25-29"><a href="#cb25-29"></a>  mat U_m, V_m;</span>
<span id="cb25-30"><a href="#cb25-30"></a>  vec <span class="va">s_m</span>;</span>
<span id="cb25-31"><a href="#cb25-31"></a></span>
<span id="cb25-32"><a href="#cb25-32"></a>  svds(U_m, <span class="va">s_m</span>, V_m, M, r);</span>
<span id="cb25-33"><a href="#cb25-33"></a></span>
<span id="cb25-34"><a href="#cb25-34"></a>  <span class="co">// sum(A % B) finds the diag(A^T B) / the diagonal of the cross product</span></span>
<span id="cb25-35"><a href="#cb25-35"></a>  <span class="co">// sum() does a *column-wise sum*, % an elementwise multiplication</span></span>
<span id="cb25-36"><a href="#cb25-36"></a>  rowvec u_sign = sign(sum(U_m % <span class="dt">U_t</span>));</span>
<span id="cb25-37"><a href="#cb25-37"></a>  rowvec v_sign = sign(sum(V_m % V_p));</span>
<span id="cb25-38"><a href="#cb25-38"></a></span>
<span id="cb25-39"><a href="#cb25-39"></a>  rowvec <span class="va">s_hat</span> = u_sign % v_sign;</span>
<span id="cb25-40"><a href="#cb25-40"></a>  lambda_hat = lambda_hat % conv_to&lt; vec &gt;::from(<span class="va">s_hat</span>);</span>
<span id="cb25-41"><a href="#cb25-41"></a></span>
<span id="cb25-42"><a href="#cb25-42"></a>  <span class="cf">return</span> Rcpp::List::create(Rcpp::Named(<span class="st">"u"</span>) = <span class="dt">U_t</span>,</span>
<span id="cb25-43"><a href="#cb25-43"></a>                            Rcpp::Named(<span class="st">"d"</span>) = lambda_hat,</span>
<span id="cb25-44"><a href="#cb25-44"></a>                            Rcpp::Named(<span class="st">"v"</span>) = V_p);</span>
<span id="cb25-45"><a href="#cb25-45"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="kw">using</span> <span class="kw">namespace</span> arma;</span>
<span id="cb26-4"><a href="#cb26-4"></a></span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>Rcpp::List AdaptiveImpute(<span class="at">const</span> sp_mat&amp; M, <span class="at">const</span> <span class="dt">int</span> r) {</span>
<span id="cb26-8"><a href="#cb26-8"></a>  </span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="at">const</span> <span class="dt">double</span> EPSILON = <span class="fl">0.000001</span>;</span>
<span id="cb26-10"><a href="#cb26-10"></a>  </span>
<span id="cb26-11"><a href="#cb26-11"></a>  </span>
<span id="cb26-12"><a href="#cb26-12"></a>  </span>
<span id="cb26-13"><a href="#cb26-13"></a>  s &lt;- adaptive_initialize(M, r)</span>
<span id="cb26-14"><a href="#cb26-14"></a>  Z &lt;- s<span class="er">$</span>u %*% diag(s<span class="er">$</span>d) %*% t(s<span class="er">$</span>v)  <span class="er"># line 1</span></span>
<span id="cb26-15"><a href="#cb26-15"></a>  delta &lt;- Inf</span>
<span id="cb26-16"><a href="#cb26-16"></a>  </span>
<span id="cb26-17"><a href="#cb26-17"></a>  <span class="cf">while</span> (delta &gt; epsilon) {</span>
<span id="cb26-18"><a href="#cb26-18"></a>    </span>
<span id="cb26-19"><a href="#cb26-19"></a>    y &lt;- as(M, <span class="st">"lgCMatrix"</span>)  <span class="er"># indicator if entry of M observed</span></span>
<span id="cb26-20"><a href="#cb26-20"></a>    M_tilde &lt;- M + Z * (<span class="dv">1</span> - y)  <span class="er"># line 3</span></span>
<span id="cb26-21"><a href="#cb26-21"></a>    </span>
<span id="cb26-22"><a href="#cb26-22"></a>    svd_M &lt;- svds(M_tilde, r)</span>
<span id="cb26-23"><a href="#cb26-23"></a>    </span>
<span id="cb26-24"><a href="#cb26-24"></a>    u_hat &lt;- svd_M<span class="er">$</span>u  <span class="er"># line 4</span></span>
<span id="cb26-25"><a href="#cb26-25"></a>    v_hat &lt;- svd_M<span class="er">$</span>v  <span class="er"># line 5</span></span>
<span id="cb26-26"><a href="#cb26-26"></a>    </span>
<span id="cb26-27"><a href="#cb26-27"></a>    d &lt;- ncol(M)</span>
<span id="cb26-28"><a href="#cb26-28"></a>    </span>
<span id="cb26-29"><a href="#cb26-29"></a>    alpha &lt;- (sum(M_tilde^<span class="dv">2</span>) - sum(svd_M<span class="er">$</span>d^<span class="dv">2</span>)) / (d - r)  <span class="er"># line 6</span></span>
<span id="cb26-30"><a href="#cb26-30"></a>    </span>
<span id="cb26-31"><a href="#cb26-31"></a>    lambda_hat &lt;- sqrt(svd_M<span class="er">$</span>d^<span class="dv">2</span> - alpha)  <span class="er"># line 7</span></span>
<span id="cb26-32"><a href="#cb26-32"></a>    </span>
<span id="cb26-33"><a href="#cb26-33"></a>    Z_new &lt;- u_hat %*% diag(lambda_hat) %*% t(v_hat)</span>
<span id="cb26-34"><a href="#cb26-34"></a>    </span>
<span id="cb26-35"><a href="#cb26-35"></a>    delta &lt;- sum((Z_new - Z)^<span class="dv">2</span>) / sum(Z^<span class="dv">2</span>)</span>
<span id="cb26-36"><a href="#cb26-36"></a>    Z &lt;- Z_new</span>
<span id="cb26-37"><a href="#cb26-37"></a>    </span>
<span id="cb26-38"><a href="#cb26-38"></a>    print(glue::glue(<span class="st">"delta: {round(delta, 8)}, alpha: {round(alpha, 3)}"</span>))</span>
<span id="cb26-39"><a href="#cb26-39"></a>  }</span>
<span id="cb26-40"><a href="#cb26-40"></a>  </span>
<span id="cb26-41"><a href="#cb26-41"></a>  Z</span>
<span id="cb26-42"><a href="#cb26-42"></a>}</span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://alexpghayes.com" class="external-link">Alex Hayes</a>, Juhee Cho, Donggyu Kim, <a href="http://pages.stat.wisc.edu/~karlrohe/" class="external-link">Karl Rohe</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
