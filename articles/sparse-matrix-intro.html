<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to sparse computations • fastadi</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to sparse computations">
<meta property="og:description" content="fastadi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fastadi</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9011</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/adaptive-impute.html">An introduction to AdaptiveInitialize and AdaptiveImpute</a>
    </li>
    <li>
      <a href="../articles/efficient-sparse-computation.html">Using memory-efficient sparse computations</a>
    </li>
    <li>
      <a href="../articles/sparse-matrix-intro.html">Introduction to sparse computations</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/RoheLab/fastadi/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sparse-matrix-intro_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to sparse computations</h1>
                        <h4 class="author">Alex Hayes</h4>
            
            <h4 class="date">2020-10-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/RoheLab/fastadi/blob/master/vignettes/sparse-matrix-intro.Rmd"><code>vignettes/sparse-matrix-intro.Rmd</code></a></small>
      <div class="hidden name"><code>sparse-matrix-intro.Rmd</code></div>

    </div>

    
    

<div id="abstract" class="section level2">
<h2 class="hasAnchor">
<a href="#abstract" class="anchor"></a>Abstract</h2>
<p>TODO: motivate ugh this is a show</p>
<p>This paper is a tutorial covering the computational details associated with computing the low-rank rank adaptive imputations for matrices described in <span class="citation">(Cho, Kim, and Rohe <a href="#ref-cho_asymptotic_2015" role="doc-biblioref">2015</a>, <a href="#ref-cho_intelligent_2018" role="doc-biblioref">2018</a>)</span>. This work extends previous data adaptive matrix imputation strategies such as that of <span class="citation">(Mazumder, Hastie, and Tibshirani <a href="#ref-mazumder_spectral_2010" role="doc-biblioref">2010</a>)</span>, and has better performance while eliminating tuning parameters.</p>
<p>The tutorial proceeds in three parts. First, we introduce the imputation algorithms, useful tidbits of linear algebra and the R package <code>Matrix</code>, which we will use to illustrate computations. After a naive initial implementation which eats up lots of memory, we demonstrate a memory-efficient implementation. Finally, we extend this memory-efficient implementation to the partially observed matrices that possibly have a large number of observed zeros.</p>
<p><span class="citation">(Bates <a href="#ref-bates_introduction_2005" role="doc-biblioref">2005</a>; Cho, Kim, and Rohe <a href="#ref-cho_asymptotic_2015" role="doc-biblioref">2015</a>, <a href="#ref-cho_intelligent_2018" role="doc-biblioref">2018</a>; Maechler and Bates <a href="#ref-maechler_2nd_2006" role="doc-biblioref">2006</a>; Mazumder, Hastie, and Tibshirani <a href="#ref-mazumder_spectral_2010" role="doc-biblioref">2010</a>; Bro, Acar, and Kolda <a href="#ref-bro_resolving_2007" role="doc-biblioref">2007</a>)</span></p>
</div>
<div id="notation-algorithm" class="section level2">
<h2 class="hasAnchor">
<a href="#notation-algorithm" class="anchor"></a>Notation &amp; Algorithm</h2>
<p>There are two steps to computing the low rank approximation of <span class="citation">(Cho, Kim, and Rohe <a href="#ref-cho_intelligent_2018" role="doc-biblioref">2018</a>)</span>. First we use compute an initial low rank estimate with the <code>AdaptiveInitialize</code> algorithm. This step is essentially a debiased SVD. We then use the initial solution as a seed for the <code>AdaptiveImpute</code> algorithm, a form of iterative SVD thresholding with a data adaptive thresholding parameter.</p>
<p>The input to these algorithms is a partially observed matrix <span class="math inline">\(M\)</span>, and <span class="math inline">\(r\)</span>, the desired rank of the low-rank approximation. We define <span class="math inline">\(Y\)</span> to be an indicator matrix that tells us whether or not we observed a particular value of <span class="math inline">\(M\)</span>.</p>

<p>Here <span class="math inline">\(\mathbf{u}_i, \boldsymbol{\lambda}_i, \mathbf{v}_i\)</span> are functions that return the <span class="math inline">\(i^{th}\)</span> left singular vector, singular value, and right singular value, respectively. <span class="math inline">\(\tilde \alpha\)</span> is the data adaptive thresholding parameter. Note that it is the average of the uncalculated singular values, and is thus positive.</p>
<p>In line 8, <span class="math inline">\(\langle , \rangle\)</span> denotes the Frobenius inner norm. That is, for vectors <span class="math inline">\(x, y\)</span> and matrices <span class="math inline">\(A, B\)</span>:</p>
<p><span class="math display">\[\begin{align}
\langle x, y \rangle &amp;= x^T y = \sum_{i} x_i y_i \\
\langle A, B \rangle &amp;= \sum_{i, j} A_{ij} B_{ij} = \sum_{ij} A \odot B \\
\end{align}\]</span></p>
<p>We use <span class="math inline">\(A \odot B\)</span> to mean the elementwise (Hadamard) product of matrices <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span>.</p>
<p>We can use the output of <code>AdaptiveInitialize</code> to construct a low rank approximation to <span class="math inline">\(M\)</span> via:</p>
<p><span class="math display">\[\begin{align}
\hat M = \sum_{i=1}^r \hat \lambda_i \hat U_i \hat V_i^T
\end{align}\]</span></p>
<p>Next up is <code>AdaptiveImpute</code>:</p>

<p>Here we again have some new notation. First we define</p>
<p><span class="math display">\[\begin{align}
P_\Omega(A) &amp;= A \odot Y \\
P_\Omega^\perp (A) &amp;= A \odot (1 - Y)
\end{align}\]</span></p>
<p>These are the projecttion of a matrix <span class="math inline">\(A\)</span> onto the observed of <span class="math inline">\(M\)</span> and the unobserved elements of <span class="math inline">\(M\)</span>, respectively. Similar <span class="math inline">\(\Omega\)</span> is the set of all pairs <span class="math inline">\((i, j)\)</span> such that <span class="math inline">\(M_{i, j}\)</span> is observed. <span class="math inline">\(\boldsymbol{\lambda}_i^2 (A)\)</span> is a function that returns the <span class="math inline">\(i^{th}\)</span> <em>squared</em> singular value of <span class="math inline">\(A\)</span> (i.e. <span class="math inline">\(\boldsymbol{\lambda}_i^2 (A) = \left(\boldsymbol{\lambda}_i (A)\right)^2\)</span>). Finally <span class="math inline">\(\Vert \cdot \Vert_F\)</span> is the Frobenius norm of a matrix.</p>
</div>
<div id="pre-requisites" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-requisites" class="anchor"></a>Pre-requisites</h2>
<div id="the-matrix-package" class="section level3">
<h3 class="hasAnchor">
<a href="#the-matrix-package" class="anchor"></a>The Matrix package</h3>
<p>If you haven’t used the <code>Matrix</code> package before, we recommend reading <a href="https://cran.r-project.org/web/packages/Matrix/vignettes/Intro2Matrix.pdf">this introduction</a> as well as this <a href="https://cran.r-project.org/web/packages/Matrix/vignettes/Intro2Matrix.pdf">2nd introduction</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://Matrix.R-forge.R-project.org/">Matrix</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>

<span class="co"># create a random 8 x 12 sparse matrix with 30 nonzero entries</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/rsparsematrix.html">rsparsematrix</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">12</span>, nnz <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">M</span></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></pre></div>
<p>TODO: different storage formats for sparse matrices. CSC, triplet, symmetric. for the most part <code>Matrix</code> does the right thing for you. The triplet form will be most important for us later on when we right out some matrix multiplications by hand.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># note that Matrix objects are S4 classes so we access their</span>
<span class="co"># slots using the @ symbol</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>

<span class="va">M</span><span class="op">@</span><span class="va">x</span>  <span class="co"># vector of values in M</span>
<span class="va">M</span><span class="op">@</span><span class="va">i</span>  <span class="co"># corresponding row indices</span>

<span class="co"># if you want column indices you need a dgTMatrix</span>
<span class="va">M2</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"dgTMatrix"</span><span class="op">)</span>
<span class="va">M2</span><span class="op">@</span><span class="va">j</span>  <span class="co"># corresponding column indices // only for dgCMatrix object</span></pre></div>
<p>We will repeatedly calculate squared Frobenious norms throughout this tutorial. It’s important to know that there are <em>many, many</em> ways to calculate this norm. We will almost always calculate the squared Frobenius norm of a sparse Matrix <code>M</code> via <code><a href="https://rdrr.io/r/base/sum.html">sum(M@x^2)</a></code>. That said, these are all equivalent:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">M</span><span class="op">^</span><span class="fl">2</span>    <span class="co"># square each element in M elementwise, return as sparse matrix</span>
<span class="va">M</span><span class="op">@</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span>  <span class="co"># square each element in M elementwise, return as vector of nonzeros</span>

<span class="co"># the second version is much faster</span>
<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">M</span><span class="op">@</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">M</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">M</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm.html">norm</a></span><span class="op">(</span><span class="va">M</span>, type <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">M</span> <span class="op">*</span> <span class="va">M</span><span class="op">)</span>,
  iterations <span class="op">=</span> <span class="fl">20</span>
<span class="op">)</span></pre></div>
<p>The projections <span class="math inline">\(P_\Omega (A)\)</span> and <span class="math inline">\(P_\Omega^\perp (A)\)</span> where <span class="math inline">\(\Omega\)</span> indicates the observed elements of a matrix <span class="math inline">\(M\)</span> and <span class="math inline">\(A\)</span> is another matrix with the same dimensions as <span class="math inline">\(M\)</span>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"lgCMatrix"</span><span class="op">)</span>  <span class="co"># indicator matrix only</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">y</span> <span class="op">*</span> <span class="va">M</span>, <span class="va">M</span><span class="op">)</span>  <span class="co"># don't lose anything multiplying by indicators</span>

<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">8</span><span class="op">*</span><span class="fl">12</span><span class="op">)</span>, <span class="fl">8</span>, <span class="fl">12</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>  <span class="co"># appropriate to practice projections with</span>

<span class="co"># Omega indicates whether an entry of M was observed</span>

<span class="co"># P_Omega (A)</span>
<span class="va">A</span> <span class="op">*</span> <span class="va">y</span>

<span class="op">!</span><span class="va">y</span>

<span class="co"># P_Omega^perp (A): NOTE: this results in a *dense* matrix</span>
<span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">A</span> <span class="op">*</span> <span class="va">y</span> <span class="op">+</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="va">A</span><span class="op">)</span>  <span class="co"># can recover A from both projections together</span></pre></div>
<p>crossproducts</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>,     <span class="co"># dsCMatrix -- most specialized class, want this</span>
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">M</span><span class="op">)</span>,  <span class="co"># dgCMatrix</span>
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">M</span>,       <span class="co"># dgCMatrix</span>
  check <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></pre></div>
<p>the <code><a href="https://rdrr.io/r/base/drop.html">drop()</a></code> function helps us manage dimensions</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">one_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>
<span class="va">one_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">8</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/drop.html">drop</a></span><span class="op">(</span><span class="va">one_col</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/drop.html">drop</a></span><span class="op">(</span><span class="va">one_row</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">one_col</span><span class="op">)</span>  <span class="co"># same thing, less explicit. use drop to be explicit</span></pre></div>
<p>diagonal of crossproduct</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">v_sign</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">svd_M</span><span class="op">$</span><span class="va">v</span> <span class="op">*</span> <span class="va">v_hat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">svd_M</span><span class="op">$</span><span class="va">v</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">v_hat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="va">svd_M</span><span class="op">$</span><span class="va">v</span>, <span class="va">v_hat</span><span class="op">)</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">svd_M</span><span class="op">$</span><span class="va">v</span> <span class="op">*</span> <span class="va">v_hat</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">d</span><span class="op">)</span>, <span class="va">svd_M</span><span class="op">$</span><span class="va">v</span> <span class="op">*</span> <span class="va">v_hat</span><span class="op">)</span>,
  iterations <span class="op">=</span> <span class="fl">50</span>,
  check <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># write a diag_crossprod helper</span></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">4</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span> <span class="op">%*%</span> <span class="va">rhos</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">rhos</span> <span class="op">*</span> <span class="va">rhos</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span><span class="op">)</span>, <span class="va">rhos</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,
  check <span class="op">=</span> <span class="cn">FALSE</span>                            
<span class="op">)</span>


<span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, ncol <span class="op">=</span> <span class="fl">4</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">tcrossprod</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">rhos</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">rhos</span> <span class="op">*</span> <span class="va">rhos</span><span class="op">)</span>,
  check <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></pre></div>
<p>what we get from <code><a href="https://rdrr.io/r/base/eigen.html">eigen()</a></code> and <code><a href="https://rdrr.io/r/base/svd.html">svd()</a></code>: slightly different stuff: <code>u</code>, <code>d</code> and <code>v</code> versus <code>values</code> and <code>vectors</code></p>
<p>NOTE: RSpectra <em>only</em> does truncated decompositions. if you want the full decomposition, you have to use base R stuff. different algos.</p>
</div>
</div>
<div id="brief-aside-in-sign-ambiguity" class="section level2">
<h2 class="hasAnchor">
<a href="#brief-aside-in-sign-ambiguity" class="anchor"></a>Brief aside in sign ambiguity</h2>
<p>yada yada yada the signs of the left and right singular vectors are not identified in SVD</p>
<p>A more elegant solution as proposed in <span class="citation">Bro, Acar, and Kolda (<a href="#ref-bro_resolving_2007" role="doc-biblioref">2007</a>)</span> and used in Karl’s paper is to take inner products</p>
<p>NOTE TO SELF: identifying the signs of a single SVD is a much harder task than comparing two SVDs and seeing if they are the same up to sign differences. we only need to check if they are the same up to sign differences.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/rsparsematrix.html">rsparsematrix</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">12</span>, nnz <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="co"># small example, not very sparse</span>

<span class="co"># number of singular vectors to compute</span>
<span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">k</span>, <span class="va">k</span><span class="op">)</span>
<span class="va">s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">k</span>, <span class="va">k</span><span class="op">)</span>

<span class="co"># irritating: svd() always gives you all the singular values even if you </span>
<span class="co"># only request the first K singular vectors</span>
<span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>

<span class="co"># based on the flip_signs function of</span>
<span class="co"># https://stats.stackexchange.com/questions/134282/relationship-between-svd-and-pca-how-to-use-svd-to-perform-pca</span>
<span class="va">equal_svds</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">s2</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># svd() always gives you all the singular values, but we only</span>
  <span class="co"># want to compare the first k</span>
  <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">u</span><span class="op">)</span>
  
  <span class="co"># the term sign(s$u) * sign(s2$u) performs a sign correction</span>
  
  <span class="co"># isTRUE because output of all.equal is not a boolean, it's something</span>
  <span class="co"># weird when the inputs aren't equal. lol why</span>
  
  <span class="va">u_ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">u</span>, <span class="va">s2</span><span class="op">$</span><span class="va">u</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">u</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op">(</span><span class="va">s2</span><span class="op">$</span><span class="va">u</span><span class="op">)</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="va">v_ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span>, <span class="va">s2</span><span class="op">$</span><span class="va">v</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op">(</span><span class="va">s2</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="va">d_ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span>, <span class="va">s2</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span>, check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">u_ok</span> <span class="op">&amp;&amp;</span> <span class="va">v_ok</span> <span class="op">&amp;&amp;</span> <span class="va">d_ok</span>
<span class="op">}</span></pre></div>
<div id="linear-algebra-facts" class="section level3">
<h3 class="hasAnchor">
<a href="#linear-algebra-facts" class="anchor"></a>Linear algebra facts</h3>
<p>Throughout these computations, we will repeatedly use several key facts about eigendecompositions, singular value decompositions (SVD) and the relationship between the two.</p>
<p><a href="https://en.wikipedia.org/wiki/Gramian_matrix" class="uri">https://en.wikipedia.org/wiki/Gramian_matrix</a> X’X – positive semi-def, so the singular values of M’M are the same as the eigenvalues</p>
<p>question: if A, B positive, is sum(svd(A - B)<span class="math inline">\(d) == sum(svd(A)\)</span>d) - sum(svd(B)$d)</p>
<p>answer: NO! can’t split into two easy computations and then combine them possibly use this to get some sort of bound?</p>
<p>think about what happens as p_hat -&gt; 0</p>
<p>A key observation here is that <span class="math inline">\(M^T M\)</span> and</p>
<p>Fact: sum of squared singular values is <code>trace(A^T A)</code> <a href="https://math.stackexchange.com/questions/2281721/sum-of-singular-values-of-a-matrix" class="uri">https://math.stackexchange.com/questions/2281721/sum-of-singular-values-of-a-matrix</a></p>
<p>Fact: for symmetric positive definite matrices the eigendecomp is equal to the singular value decomp</p>
<p>Fact: sum of eigenvalues of M is equal to trace(M)</p>
<p>Consequence: for pos def symmetric M the sum of the singular values is trace(M) as well</p>
<p>Again computing <code>alpha</code> deserves some explanation.</p>
<ul>
<li>reference: <a href="https://math.stackexchange.com/questions/1463269/how-to-obtain-sum-of-square-of-eigenvalues-without-finding-eigenvalues" class="uri">https://math.stackexchange.com/questions/1463269/how-to-obtain-sum-of-square-of-eigenvalues-without-finding-eigenvalues</a>
</li>
<li>Frobenius norm (A) = trace(crossprod(A))</li>
<li>TODO: how we know this thing is strictly positive to prevent sqrt() from exploding</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co">## STOPPED HERE: WHY ARE the following not the same?</span>
  <span class="fu"><a href="https://rdrr.io/r/base/isSymmetric.html">isSymmetric</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">values</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
  
  <span class="co"># let's think just about the first term for a moment</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">MtM</span> <span class="op">/</span> <span class="va">p_hat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">MtM</span> <span class="op">/</span> <span class="va">p_hat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colSums</a></span><span class="op">(</span><span class="va">M</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">p_hat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># has some negative eigenvalues</span>
  
  <span class="co"># Fact: for a symmetric matrix, the singular values are the *absolute* values</span>
  <span class="co"># of the eigenvalues</span>
  
  <span class="co"># https://www.mathworks.com/content/dam/mathworks/mathworks-dot-com/moler/eigs.pdf</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">values</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/svd.html">svd</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># those agree so what about the second term</span>
  
  <span class="co"># note to self: alpha should be positive</span>
  <span class="co"># issue karl ran into:</span>
  <span class="co"># https://math.stackexchange.com/questions/381808/sum-of-eigenvalues-and-singular-values</span>
  <span class="co"># how to get the sum of singular values itself (start):</span>
  <span class="co"># https://math.stackexchange.com/questions/569989/sum-of-singular-values-of-ab</span>
  
  <span class="co"># options when sigma_p is not positive definite:</span>
  <span class="co"># - calculate the full SVD</span>
  <span class="co"># - set alpha to zero (don't truncate the singular values)</span>
  <span class="co"># - this lower bounds the average of the remaining singular values</span>
  <span class="co"># -</span>
  
  <span class="co"># positive semi-definite is enough since symmetric and eigen/singular values</span>
  <span class="co"># of zero don't matter</span>
  
  <span class="co"># this is only an issue in the initialization. in the iterative updates</span>
  <span class="co"># we use the squared singular values, which we can more easily calculate</span>
  <span class="co"># the sum of</span>
  
  <span class="co"># ask Karl what he wants to do about this: computing a full SVD is gonna be really expensive.</span></pre></div>
<p>FACT: sum(diag(crossprod(M))) == sum(M^2)</p>
</div>
</div>
<div id="reference-implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#reference-implementation" class="anchor"></a>Reference implementation</h2>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yixuan/RSpectra">RSpectra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://Matrix.R-forge.R-project.org/">Matrix</a></span><span class="op">)</span></pre></div>
<!-- ```{#AdaptiveImpute .R .numberLines} -->
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">adaptive_initialize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># TODO: ignores observed zeros!</span>
  <span class="va">p_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/nnzero.html">nnzero</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>  <span class="co"># line 1</span>
  
  <span class="va">MtM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="va">MMt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">tcrossprod</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  
  <span class="co"># need to divide by p^2 from Cho et al 2016 to get the "right"</span>
  <span class="co"># singular values / singular values on a comparable scale</span>
  
  <span class="co"># both of these matrices are symmetric, but not necessarily positive</span>
  <span class="co"># this has important implications for the SVD / eigendecomp relationship</span>
  
  <span class="va">sigma_p</span> <span class="op">&lt;-</span> <span class="va">MtM</span> <span class="op">/</span> <span class="va">p_hat</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_hat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">MtM</span><span class="op">)</span><span class="op">)</span>  <span class="co"># line 2</span>
  <span class="va">sigma_t</span> <span class="op">&lt;-</span> <span class="va">MMt</span> <span class="op">/</span> <span class="va">p_hat</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_hat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">MMt</span><span class="op">)</span><span class="op">)</span>  <span class="co"># line 3</span>
  
  <span class="co"># crossprod() and tcrossprod() return dsCMatrix objects,</span>
  <span class="co"># sparse matrix objects that know they are symmetric</span>
  
  <span class="co"># unfortunately, RSpectra doesn't support dsCMatrix objects,</span>
  <span class="co"># but does support dgCMatrix objects, a class representing sparse</span>
  <span class="co"># but not symmetric matrices</span>
  
  <span class="co"># support for dsCMatrix objects in RSpectra is on the way,</span>
  <span class="co"># which will eliminate the need for the following coercions.</span>
  <span class="co"># see: https://github.com/yixuan/RSpectra/issues/15</span>
  
  <span class="va">sigma_p</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">sigma_p</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span>
  <span class="va">sigma_t</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">sigma_t</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span>
  
  <span class="va">svd_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html">svds</a></span><span class="op">(</span><span class="va">sigma_p</span>, <span class="va">r</span><span class="op">)</span>  <span class="co"># TODO: is eigs_sym() faster?</span>
  <span class="va">svd_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html">svds</a></span><span class="op">(</span><span class="va">sigma_t</span>, <span class="va">r</span><span class="op">)</span>
  
  <span class="va">v_hat</span> <span class="op">&lt;-</span> <span class="va">svd_p</span><span class="op">$</span><span class="va">v</span>  <span class="co"># line 4</span>
  <span class="va">u_hat</span> <span class="op">&lt;-</span> <span class="va">svd_t</span><span class="op">$</span><span class="va">u</span>  <span class="co"># line 5</span>
  
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  
  <span class="co"># NOTE: alpha is incorrect due to singular values and eigenvalues</span>
  <span class="co"># being different when sigma_p is not positive</span>
  
  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">sigma_p</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">svd_p</span><span class="op">$</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span>  <span class="co"># line 6</span>
  <span class="va">lambda_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">svd_p</span><span class="op">$</span><span class="va">d</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">/</span> <span class="va">p_hat</span>             <span class="co"># line 7</span>
  
  <span class="va">svd_M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html">svds</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
  
  <span class="va">v_sign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">d</span><span class="op">)</span>, <span class="va">svd_M</span><span class="op">$</span><span class="va">v</span> <span class="op">*</span> <span class="va">v_hat</span><span class="op">)</span>
  <span class="va">u_sign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">crossprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>, <span class="va">svd_M</span><span class="op">$</span><span class="va">u</span> <span class="op">*</span> <span class="va">u_hat</span><span class="op">)</span>
  <span class="va">s_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html">drop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op">(</span><span class="va">v_sign</span> <span class="op">*</span> <span class="va">u_sign</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">lambda_hat</span> <span class="op">&lt;-</span> <span class="va">lambda_hat</span> <span class="op">*</span> <span class="va">s_hat</span>  <span class="co"># line 8</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">u_hat</span>, d <span class="op">=</span> <span class="va">lambda_hat</span>, v <span class="op">=</span> <span class="va">v_hat</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>It’s worth commenting on computation of <code>alpha</code> and <code>s_hat</code>.</p>
<p>When we compute <code>alpha</code> in line 20 <code><a href="../reference/adaptive_initialize.html">adaptive_initialize()</a></code>, we don’t want to do the full eigendecomposition of <span class="math inline">\(\Sigma_{\hat p}\)</span> since that could take a long time, so we use trick and recall that the trace of a matrix (the sum of it’s diagonal elements) equals the sum of all the eigenvalues. Then we subtract off the first <span class="math inline">\(r\)</span> eigenvalues, which we do compute, and are left with <span class="math inline">\(\sum_{i = r + 1}^d \lambda_i(\Sigma_{\hat p})\)</span>.</p>
<!-- ```{#AdaptiveImpute .R .numberLines} -->
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">adaptive_impute</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span>, <span class="va">epsilon</span> <span class="op">=</span> <span class="fl">1e-7</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adaptive_initialize.html">adaptive_initialize</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">r</span><span class="op">)</span>
  <span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">u</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>  <span class="co"># line 1</span>
  <span class="va">delta</span> <span class="op">&lt;-</span> <span class="cn">Inf</span>
  
  <span class="kw">while</span> <span class="op">(</span><span class="va">delta</span> <span class="op">&gt;</span> <span class="va">epsilon</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">M</span>, <span class="st">"lgCMatrix"</span><span class="op">)</span>  <span class="co"># indicator if entry of M observed</span>
    <span class="va">M_tilde</span> <span class="op">&lt;-</span> <span class="va">M</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span>  <span class="co"># line 3</span>
    
    <span class="va">svd_M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html">svds</a></span><span class="op">(</span><span class="va">M_tilde</span>, <span class="va">r</span><span class="op">)</span>
    
    <span class="va">u_hat</span> <span class="op">&lt;-</span> <span class="va">svd_M</span><span class="op">$</span><span class="va">u</span>  <span class="co"># line 4</span>
    <span class="va">v_hat</span> <span class="op">&lt;-</span> <span class="va">svd_M</span><span class="op">$</span><span class="va">v</span>  <span class="co"># line 5</span>
    
    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
    
    <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">M_tilde</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">svd_M</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span>  <span class="co"># line 6</span>
    
    <span class="va">lambda_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">svd_M</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span>  <span class="co"># line 7</span>
    
    <span class="va">Z_new</span> <span class="op">&lt;-</span> <span class="va">u_hat</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">lambda_hat</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">v_hat</span><span class="op">)</span>
    
    <span class="va">delta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">Z_new</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Z</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">Z_new</span>
    
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"delta: {round(delta, 8)}, alpha: {round(alpha, 3)}"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">Z</span>
<span class="op">}</span></pre></div>
<p>Finally we can do a minimal sanity check and see if this code even runs, and see if we are recovering something close-ish to implanted low-rank structure.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">r</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">d</span> <span class="op">*</span> <span class="va">r</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">d</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">M0</span> <span class="op">&lt;-</span> <span class="va">A</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span>

<span class="va">err</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">d</span><span class="op">)</span>
<span class="va">Mf</span> <span class="op">&lt;-</span> <span class="va">M0</span> <span class="op">+</span> <span class="va">err</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.3</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">d</span>, <span class="fl">1</span>, <span class="va">p</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">d</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">Mf</span> <span class="op">*</span> <span class="va">y</span>

<span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adaptive_initialize.html">adaptive_initialize</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">r</span><span class="op">)</span>
<span class="va">filled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adaptive_impute.html">adaptive_impute</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">r</span><span class="op">)</span></pre></div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-bates_introduction_2005">
<p>Bates, Douglas. 2005. “Introduction to the Matrix Package.” <a href="https://cran.r-project.org/web/packages/Matrix/vignettes/Introduction.pdf">https://cran.r-project.org/web/packages/Matrix/vignettes/Introduction.pdf</a>.</p>
</div>
<div id="ref-bro_resolving_2007">
<p>Bro, Rasmus, Evrim Acar, and Tamara G. Kolda. 2007. “Resolving the Sign Ambiguity in the Singular Value Decomposition,” 18.</p>
</div>
<div id="ref-cho_asymptotic_2015">
<p>Cho, Juhee, Donggyu Kim, and Karl Rohe. 2015. “Asymptotic Theory for Estimating the Singular Vectors and Values of a Partially-Observed Low Rank Matrix with Noise.” <em>arXiv:1508.05431 [Stat]</em>, August. <a href="http://arxiv.org/abs/1508.05431">http://arxiv.org/abs/1508.05431</a>.</p>
</div>
<div id="ref-cho_intelligent_2018">
<p>———. 2018. “Intelligent Initialization and Adaptive Thresholding for Iterative Matrix Completion; Some Statistical and Algorithmic Theory for Adaptive-Impute.” <em>Journal of Computational and Graphical Statistics</em>, September, 1–26. <a href="https://doi.org/10.1080/10618600.2018.1518238">https://doi.org/10.1080/10618600.2018.1518238</a>.</p>
</div>
<div id="ref-maechler_2nd_2006">
<p>Maechler, Martin, and Douglas Bates. 2006. “2nd Introduction to the Matrix Package.” <a href="https://cran.r-project.org/web/packages/Matrix/vignettes/Intro2Matrix.pdf">https://cran.r-project.org/web/packages/Matrix/vignettes/Intro2Matrix.pdf</a>.</p>
</div>
<div id="ref-mazumder_spectral_2010">
<p>Mazumder, Rahul, Trevor Hastie, and Robert Tibshirani. 2010. “Spectral Regularization Algorithms for Learning Large Incomplete Matrices.” <a href="https://web.stanford.edu/~hastie/Papers/mazumder10a.pdf">https://web.stanford.edu/~hastie/Papers/mazumder10a.pdf</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://alexpghayes.com">Alex Hayes</a>, Juhee Cho, Donggyu Kim, <a href="http://pages.stat.wisc.edu/~karlrohe/">Karl Rohe</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
